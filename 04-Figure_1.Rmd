---
title: "Load Data"
output: html_document
editor_options: 
  chunk_output_type: console
---
# Figure 1


## Use Fresh Sertoli / granulosa data to define somatic genes that are differentially expressed

```{r somatic_gonad,eval=T}
#use differential expression between granulosa and Sertoli to define genes of interest
as.data.frame(colData(dds_soma<-dds[,str_detect(colData(dds)$time,"fresh")]))
#plotPCA(normTransform(dds_soma),intgroup=c("gene")) + theme_bw()
dds_soma$gene <- droplevels(dds_soma$gene)
design(dds_soma)<- ~ gene 
dds_soma<-DESeq(dds_soma)

#fpkm table
#get fpkm
dim(f_soma<-as.data.frame(log2(fpkm(dds_soma)+0.1)))

#colnames(f_gonad)<-paste(colData(dds_gonad)$time,colData(dds_gonad)$gene,colData(dds_gonad)$sox,1:nrow(colData(dds_gonad)),sep="_")
#f_gonad$mgi_symbol<-mcols(dds_gonad)$mgi_symbol
#View(f_gonad)

f_soma_mean <- f_soma %>% 
  tibble::rownames_to_column(var="ensembl") %>%
  tidyr::gather(sample,fpkm,-ensembl) %>% 
  dplyr::mutate(sex=colData(dds_soma)[sample,]$gene) %>% 
  dplyr::mutate(sex=gsub("control","granulosa",sex)) %>% 
  dplyr::group_by(sex,ensembl) %>% 
    dplyr::summarize(mean_fpkm=round(mean(fpkm),3)) %>% 
    dplyr::select(sex,ensembl,mean_fpkm) %>% 
    ungroup() %>% 
  tidyr::spread(sex,mean_fpkm) %>% as.data.frame()

  rownames(f_soma_mean) <- f_soma_mean$ensembl
  f_soma_mean<-f_soma_mean[,-1]
  
f_soma_mean$symbol<-mcols(dds_soma)[match(rownames(f_soma_mean),rownames(dds_soma)),]$symbol
length(high_soma_fpkm<-rownames(f_soma_mean[apply(f_soma_mean,1,max) > log2(2.5),]))
table(symbols[symbols$gene_id %in% high_soma_fpkm,"chr"])


#DEGs
resultsNames(dds_soma)
(summary(results_soma<-results(dds_soma)))
results_soma$mgi_symbol<-mcols(dds_soma)$symbol
#results_soma<-results_soma[!(is.na(results_soma$log2FoldChange) | is.na(results_soma$padj)),]
results_soma<-results_soma[with(results_soma,order(padj)),]

results_soma$f_sertoli<-f_soma_mean[match(rownames(results_soma),rownames(f_soma_mean)),]$sertoli
results_soma$f_granulosa<-f_soma_mean[match(rownames(results_soma),rownames(f_soma_mean)),]$granulosa

#View(as.data.frame(results_soma))


write.csv(results_soma,file="granulosa_vs_Sertoli_comparison.csv",quote=F)



#define a list of Sertoli Up genes for later
length(sertoli_up<-rownames(subset(results_soma,log2FoldChange > 1 & padj < 0.05 & f_sertoli > 2.5 & f_granulosa < 1.0)))
table(symbols[symbols$gene_id %in% sertoli_up,"chr"])
length(granulosa_up<-rownames(subset(results_soma,log2FoldChange < -1 & padj < 0.05 & f_sertoli < 1.0 & f_granulosa > 2.5)))
table(symbols[symbols$gene_id %in% granulosa_up,"chr"])

#define transcripts fore each set
sertoli_transcripts<-transcripts[transcripts$gene_id %in% sertoli_up]
granulosa_transcripts<-transcripts[transcripts$gene_id %in% granulosa_up]

#View(as.data.frame(results_soma[sertoli_up,]))


nrow(temp<-as.data.frame(results_soma))

#subset to significant genes (###use fpkm cutoff instead of baseMean?)
nrow(results_soma<-subset(results_soma,abs(log2FoldChange) > 4 & padj < 0.05 & baseMean > 200))
table(symbols[symbols$gene_id %in% rownames(results_soma),"chr"])

table(temp$results_soma<- factor(case_when (
  temp$log2FoldChange > 4 & temp$padj < 0.05 & temp$baseMean > 200 ~ "Sertoli",
  temp$log2FoldChange < -4 & temp$padj < 0.05 & temp$baseMean > 200 ~ "Granulosa",
  TRUE ~ "unchanged"
  ),levels=c("Granulosa","unchanged","Sertoli")))
  

df<-temp[temp$mgi_symbol %in% c("Dmrt1","Nr5a2","Esr2","Foxl2","Sox8","Sox9","Cyp19a1","Cytip","Hsd17b3"),]

temp %>% 
  dplyr::filter(!is.na(log2FoldChange) & !is.na(padj)) %>% 
ggplot(aes(x=log2FoldChange,y=(-1*log10(padj)),color=results_soma)) + geom_point() + theme_bw() + scale_color_manual(values=c("red","darkgray","blue")) +
  annotate("text",x=df$log2FoldChange,y=(-1*log10(df$padj)),label=df$mgi_symbol)

```

## Create a DDS object of the whole gonad samples
```{r }
as.data.frame(colData(dds_gonad<-dds[,str_detect(colData(dds)$time,"ovary|testis") & !str_detect(colData(dds)$filename,"DMEf|WTf")]))
colData(dds_gonad)$sox8<-as.numeric(substr(colData(dds_gonad)$gene,2,2))
colData(dds_gonad)$sox9<-as.numeric(substr(colData(dds_gonad)$gene,3,3))
colData(dds_gonad)$sox<-colData(dds_gonad)$sox8+colData(dds_gonad)$sox9
colData(dds_gonad)$gene<-as.factor(sapply(str_split(colData(dds_gonad)$gene,"_"), function(x) x[2]))
colData(dds_gonad)$batch<-as.factor(colData(dds_gonad)$batch)
as.data.frame(colData(dds_gonad))
plotPCA(normTransform(dds_gonad),intgroup=c("userid","time","gene","sox")) + 
  theme_bw() + ggtitle("Gonad Data - Full Gene Set ")

#subset to ~soma
#dim(dds_gonad)
#dim(dds_gonad_subset<-dds_gonad[rownames(dds_gonad) %in% rownames(results_soma),])
#as.data.frame(colData(dds_gonad_subset))
#plotPCA(normTransform(dds_gonad_subset),intgroup=c("time","gene","sox")) + 
#  theme_bw() + ggtitle("Gonad Data - Somatic Subset")
#pheatmap(f_gonad_subset)
```



## Figure 1a - UpsetR
```{r upset,eval=T}


length(vivo_atac<-reduce(c(peak_e105_atac_XX,peak_e105_atac_XY,peak_e135_atac_XX,peak_e135_atac_XY,peak_p23_atac_XX,peak_p7_atac_XY)))

length(vivo_atac<-keepSeqlevels(vivo_atac,c(1:19,"X"),pruning.mode="coarse"))  #drop Y because not all samples have a Y
length(vivo_atac<-suppressWarnings(vivo_atac[!vivo_atac %over% mito_homologs]))

head(names(vivo_atac)<-paste0("vivo_atac",formatC(1:length(vivo_atac),width=6,format="d",flag="0")))


summary(width(vivo_atac))


(fls.k27ac_p3_Sert <- list.files("../data", pattern=glob2rx("*.bam$"),full=TRUE) %>%
   grep("k27",.,value=T) %>%
   grep("wt",.,value=T) %>%
   grep("GW02",.,value=T) %>%
   grep("P3",.,value=T ))

#system.time(vivo_atac_k27ac_counts<- summarizeOverlaps(vivo_atac,BamFileList(fls.k27ac_p3_Sert,yieldSize = 1e5),mode =Union, ignore.strand=T))
#as.data.frame(apply(assays(vivo_atac_k27ac_counts)$counts,2,sum))
#save(vivo_atac_k27ac_counts,file="vivo_atac_k27ac_counts.rdata")
load("vivo_atac_k27ac_counts.rdata")


temp<-as.data.frame(assays(vivo_atac_k27ac_counts)$counts)
colnames(temp)<-c("wt_idx13","wt_idx14")
head(temp)
colSums(temp)
temp<-sweep(temp,2,colSums(temp)/1e6,"/")
temp$width<-width(vivo_atac)
temp2<-data.frame(p3_XY_k27ac=(temp$wt_idx13 + temp$wt_idx14)/(0.002*temp$width))
head(temp2)
mcols(vivo_atac)<-log2(temp2+0.5)


vivo_atac$e105_XX<-as.numeric(vivo_atac %over% peak_e105_atac_XX)
vivo_atac$e105_XY<-as.numeric(vivo_atac %over% peak_e105_atac_XY)
vivo_atac$e135_XX<-as.numeric(vivo_atac %over% peak_e135_atac_XX)
vivo_atac$e135_XY<-as.numeric(vivo_atac %over% peak_e135_atac_XY)
vivo_atac$p23_XX<-as.numeric(vivo_atac %over% peak_p23_atac_XX)
vivo_atac$p7_XY<-as.numeric(vivo_atac %over% peak_p7_atac_XY)

colSums(as.data.frame(mcols(vivo_atac)))

upset(as.data.frame(mcols(vivo_atac)), nsets = 4, number.angles = 30, point.size = 3.5, line.size = 2,
    mainbar.y.label = "Peak Intersections", main.bar.color = "black",
    sets=c("p7_XY","p23_XX","e135_XY","e135_XX","e105_XY","e105_XX"), sets.x.label = "Numebr of Peaks", keep.order = TRUE,
    queries=list(list(query = intersects, params = list("p7_XY", "e135_XY"),color = "blue", active = T)),text.scale = c(1.3, 1.3, 1, 1, 2, 0.75),
     boxplot.summary = c("p3_XY_k27ac"))

```




## Figure 0b  - Combine Embryonic Data with WT vs Sertoli DARs
### Map Genes to DARs
### Define g_regions and s_regions for DARs close to granulosa expressed genes and Sertoli expressed genes

```{r}
#Find Differentially bound ATAC-able regions

(fls1.vivo <- list.files("../data", pattern=glob2rx("*.bam$"),full=TRUE) %>% str_subset("/N70"))
(fls2.vivo <- list.files("../data", pattern=glob2rx("*.bam$"),full=TRUE) %>% str_subset("futtner"))
(fls3.vitro <- list.files("../data", pattern=glob2rx("*.bam$"),full=TRUE) %>% str_subset("ATAC") %>% str_subset("gran") %>% str_subset("P043"))
(fls4.vitro <- list.files("../data", pattern=glob2rx("*.bam$"),full=TRUE) %>% 
   grep("ATAC",.,value=T) %>% 
   grep("marked",.,value=T,invert=T) %>% 
   grep("P037",.,value=T) %>% 
   grep("gran",.,value=T ))

#system.time(atac_counts<- summarizeOverlaps(vivo_atac,BamFileList(c(fls1.vivo,fls2.vivo,fls3.vitro,fls4.vitro),yieldSize = 1e5),mode =Union, ignore.strand=T))
#apply(assays(atac_counts)$counts,2,sum)
#save(atac_counts,file="atac_counts.rdata")
load("atac_counts.rdata")

#mcols(vivo_atac)<-assays(atac_counts)$counts
#colnames(mcols(vivo_atac))<-colnames(assays(atac_counts)$counts) %>% gsub("\\.R1_trimmed\\.fastq\\.marked\\.bam","",.)
atac_dds<-DESeqDataSet(atac_counts,design = ~1)
mcols(atac_dds)$basepairs<-width(vivo_atac)
colData(atac_dds)$sample<-colnames(assays(atac_counts)$counts) %>% gsub("\\.R1_trimmed\\.fastq\\.marked\\.bam","",.) %>% 
  gsub("futtner_ATAC_","",.) %>% gsub("_R1_trimmed\\.bam","",.) %>% 
  gsub("\\.marked\\.bam","",.) %>%  gsub("\\.bam","",.) 

colData(atac_dds)$sex<-factor(c(rep("Male",2),rep("Female",4),rep("Male",2),rep("Female",2),rep("Male",2),rep("Female",12)))
colData(atac_dds)$age<-factor(c(rep("postnatal",4),rep("E105",4),rep("E135",4),rep("postnatal",12)),levels=c("E105","E135","postnatal"))
colData(atac_dds)$cag<-factor(c(rep("na",12),rep("Sox9",3),rep("na",5),"Dmrt1","na",rep("Dmrt1",2)),levels=c("na","Sox9","Dmrt1"))

colData(atac_dds)$group<-factor(paste0(colData(atac_dds)$age,"_",colData(atac_dds)$sex,"_",colData(atac_dds)$cag),
                        levels=c("E105_Female_na","E105_Male_na","E135_Female_na","E135_Male_na","postnatal_Female_na","postnatal_Male_na","postnatal_Female_Sox9","postnatal_Female_Dmrt1"))

as.data.frame(colData(atac_dds))

#Move to Figure 5
#(df<-plotPCA(normTransform(atac_dds),intgroup=c("group"),returnData=T,ntop=500))
#
#plotPCA(normTransform(atac_dds),intgroup=c("group"),ntop=500) + theme_bw() +
#  scale_color_manual(values = cbPalette) + geom_text(x=df$PC1,y=df$PC2,label=df$group) 


```

## Make an  in vivo version of this PCA plot for Figure 1 (full version moved to figure 5)
```{r}
as.data.frame(colData(vivo_dds<-atac_dds[,!stringr::str_detect(colData(atac_dds)$sample,"gran")]))

as.data.frame(colData(vivo_dds))
#table(as.character(seqnames(vivo_atac)) %in% as.character(c(1:19,"X")))
#dim(vivo_dds<-vivo_dds[as.character(seqnames(vivo_atac)) %in% as.character(c(1:19,"X")),])
(df<-plotPCA(normTransform(vivo_dds),intgroup=c("sex","sample"),returnData=T,ntop=500))

df$sample<-df$sample %>% gsub("N702","Sertoli_N702_p7",.) %>%
   gsub("N703","Sertoli_N703_p7",.) %>% 
   gsub("N704","Granulosa_N704_p23",.) %>% 
   gsub("N705","Granulosa_N705_p23",.)


plotPCA(normTransform(vivo_dds),intgroup=c("sex"),ntop=500) + theme_bw() +
scale_color_manual(values = cbPalette[c(7,6)]) + geom_text(x=-1*df$PC1,y=df$PC2,label=df$sample) + scale_x_reverse()



```

#Use contrast to find differentially expressed regions between granulosa and Sertoli
```{r}

f_mean_atac_vivo <- fpkm(vivo_dds,robust=TRUE) %>% as.data.frame() %>% 
  tibble::rownames_to_column(var="region") %>% 
  tidyr::gather(sample,fpkm,-region) %>%
  dplyr::mutate(group=colData(vivo_dds)[sample,]$group) %>% 
  dplyr::group_by(region,group) %>% 
    dplyr::summarize(mean_fpkm=round(log2(mean(fpkm)+0.1),3)) %>% 
    ungroup() %>% 
  dplyr::select(region,group,mean_fpkm) %>% 
  tidyr::spread(group,mean_fpkm) %>%  as.data.frame() 

rownames(f_mean_atac_vivo)<-f_mean_atac_vivo$region
f_mean_atac_vivo<-f_mean_atac_vivo[,-1]
head(f_mean_atac_vivo)


design(vivo_dds)<-~group
vivo_dds$group<-droplevels(vivo_dds$group)
vivo_dds<-DESeq(vivo_dds)

summary(res_vivo_postnatal<-results(vivo_dds,contrast=c("group","postnatal_Male_na","postnatal_Female_na"),alpha=0.05))

vivo_atac
#Add metadata to vivo_atac gr
stopifnot(all.equal(rownames(f_mean_atac_vivo),names(vivo_atac)))
mcols(vivo_atac)<-f_mean_atac_vivo

#design(vivo_dds)<-~sex
#vivo_dds<-DESeq(vivo_dds)
#vivo_res_raw<-results(vivo_dds,alpha=0.05)
#vivo_res<-as.data.frame(vivo_res_raw)
#vivo_res$ihw<-ihw(pvalue ~ baseMean,  data = vivo_res, alpha = 0.05)@df$adj_pvalue

stopifnot(all.equal(rownames(res_vivo_postnatal),names(vivo_atac)))
vivo_atac$lfc<-res_vivo_postnatal$log2FoldChange
vivo_atac$padj<-res_vivo_postnatal$padj


## CHANGED THIS TO USE LOG2 OF THE MEAN INSTEAD OF UNTRANSFORMED INDIVIDUAL SAMPLES
#classify
table(vivo_atac$class<-case_when (
  vivo_atac$padj < 0.05 & vivo_atac$postnatal_Male_na > 3.3 & vivo_atac$postnatal_Female_na < 1 ~ "Sertoli", #3.3,1 vs 4.3,2.8
  vivo_atac$padj < 0.05 & vivo_atac$postnatal_Male_na < 1 &  vivo_atac$postnatal_Female_na > 3.3 ~ "Granulosa", # vs 2.8,4.3
  abs(vivo_atac$lfc) < log2(1.25) & vivo_atac$postnatal_Male_na > 3.3  & vivo_atac$postnatal_Female_na > 3.3  ~ "Constitutive",
  TRUE ~ "unclassified"
))

head(as.data.frame(vivo_atac))
#View(as.data.frame(vivo_atac))
vivo_atac_subset<-vivo_atac[vivo_atac$class!="unclassified"]

#phastcons
#vivo_atac_subset<-add_mean_phastcons_score(vivo_atac_subset)

#export(vivo_atac,"vivo_atac.bed")

#Which ones overlap what sites?
table(vivo_atac_subset$dmrt1<-vivo_atac_subset %over% sertoli_dmrt1)
table(vivo_atac_subset$sox9<-vivo_atac_subset %over% testis_sox9)
table(vivo_atac_subset$foxl2<-vivo_atac_subset %over% ovary_foxl2)

table(vivo_atac_subset$peak<-case_when (
  vivo_atac_subset$dmrt1 & vivo_atac_subset$sox9 & vivo_atac_subset$foxl2 ~ "DSF",
  vivo_atac_subset$dmrt1 & vivo_atac_subset$sox9 & !vivo_atac_subset$foxl2 ~ "DS",
  vivo_atac_subset$dmrt1 & !vivo_atac_subset$sox9 & !vivo_atac_subset$foxl2 ~ "D",
  !vivo_atac_subset$dmrt1 & vivo_atac_subset$sox9 & vivo_atac_subset$foxl2 ~ "SF",
  vivo_atac_subset$dmrt1 & !vivo_atac_subset$sox9 & vivo_atac_subset$foxl2 ~ "DF",
  !vivo_atac_subset$dmrt1 & vivo_atac_subset$sox9 & !vivo_atac_subset$foxl2 ~ "S",
  !vivo_atac_subset$dmrt1 & !vivo_atac_subset$sox9 & vivo_atac_subset$foxl2 ~ "F",
  !vivo_atac_subset$dmrt1 & !vivo_atac_subset$sox9 & !vivo_atac_subset$foxl2 ~ "N",
  TRUE ~ "unclassified"
))

roi<-c("vivo_atac029963","vivo_atac075082","vivo_atac078850","vivo_atac036384","vivo_atac007173")
roi<-roi[roi %in% names(vivo_atac_subset)]
df<-vivo_atac_subset[roi]
df$label<-c("Esr2","Cytip","B2m","Nr5a2")
df


  
mcols(vivo_atac_subset) %>% as.data.frame() %>% 
  dplyr::filter(!is.na(lfc) & !is.na(padj)) %>% 
ggplot(aes(x=lfc,y=(-1*log10(padj)),color=peak)) + geom_point() + theme_bw()  + scale_color_manual(values=c("blue","purple","darkgreen","red","gray","green")) +
  annotate("text",x=df$lfc,y=(-1*log10(df$padj)),label=df$label)




```


#esr2 b2m nr5a2

chr12:76,123,762-76,142,730 chr2:122,118,969-122,176,481 chr1:136,905,273-136,926,883

#normalize distance from peak
```{r}



```





# invert thinking - find all atac peaks near differentially expressed genes
```{r mean_distance,eval=F}

cutoff<-list(c(0,1000),c(1000,10000),c(10000,100000))

stratify_distance<-function(co,d) {table(vivo_atac_subset[queryHits(d)[mcols(d)$distance >= co[1] & mcols(d)$distance < co[2]]]$class)}
#stratify_distance(c(0,100000),s)

#find nearest peaks for Sertoli Specific Genes
s<-distanceToNearest(vivo_atac_subset,c(sertoli_transcripts),ignore.strand=TRUE)
lst.s<-lapply(cutoff,stratify_distance,s)
indx.s <- sapply(lst.s, length)
res.s <- as.data.frame(do.call(rbind,lapply(lst.s, `length<-`,
                          max(indx.s))))
colnames(res.s) <- names(lst.s[[which.max(indx.s)]])
res.s$window<-as.character(cutoff)
res.s
g1<-res.s %>% gather(celltype,n,-window) %>% 
  ggplot( aes(x=window, y=n, fill=celltype)) + 
  scale_fill_manual(values=c("gray","magenta","blue")) +
  geom_bar(stat="identity",position="dodge") + coord_flip() + 
  theme_bw() + theme(legend.position = "none") +
  ggtitle("Binned Distances to Sertoli Specific Transcripts")
 
#find nearest peaks for Granulsa Specific Genes
g<-distanceToNearest(vivo_atac_subset,c(granulosa_transcripts),ignore.strand=TRUE)
lst.g<-lapply(cutoff,stratify_distance,g)
indx.g <- sapply(lst.g, length)
 res.g <- as.data.frame(do.call(rbind,lapply(lst.g, `length<-`,
                          max(indx.g))))
colnames(res.g) <- names(lst.g[[which.max(indx.g)]])
res.g$window<-as.character(cutoff)
res.g

g2<-res.g %>% gather(celltype,n,-window) %>% 
  ggplot( aes(x=window, y=n, fill=celltype)) + 
  scale_fill_manual(values=c("gray","magenta","blue")) +
  geom_bar(stat="identity",position="dodge") + 
  coord_flip() + scale_y_reverse() + 
  theme_bw() + ggtitle("Binned Distances to Granulosa Specific Transcripts")
 
#plot back-to-back  
legend <- get_legend(g2)


ggdraw(plot_grid(plot_grid(g2 + theme(legend.position = "none"), g1 + theme(legend.position = "none"), ncol=2, align='h'),
                 plot_grid(NULL, legend, ncol=1),
                 rel_widths=c(1, 0.2)))

```
### make Enriched Heatmap plots of Differentially ATAC-able regions

```{r}

cutoff<-10000


s<-distanceToNearest(vivo_atac_subset,sertoli_transcripts,ignore.strand=TRUE)
vivo_atac_subset$sertoli_distance<- NA 
vivo_atac_subset$nearest_sertoli_symbol<-NA
vivo_atac_subset$nearest_sertoli_gene_id<-NA
vivo_atac_subset[queryHits(s)]$sertoli_distance<-mcols(s)$distance 
vivo_atac_subset[queryHits(s)]$nearest_sertoli_symbol<-sertoli_transcripts[subjectHits(s)]$symbol
vivo_atac_subset[queryHits(s)]$nearest_sertoli_gene_id<-sertoli_transcripts[subjectHits(s)]$gene_id

g<-distanceToNearest(vivo_atac_subset,c(granulosa_transcripts),ignore.strand=TRUE)
vivo_atac_subset$granulosa_distance<- NA 
vivo_atac_subset$nearest_granulosa_symbol<-NA
vivo_atac_subset$nearest_granulosa_gene_id<-NA
vivo_atac_subset[queryHits(g)]$granulosa_distance<-mcols(g)$distance 
vivo_atac_subset[queryHits(g)]$nearest_granulosa_symbol<-granulosa_transcripts[subjectHits(g)]$symbol
vivo_atac_subset[queryHits(g)]$nearest_granulosa_gene_id<-granulosa_transcripts[subjectHits(g)]$gene_id

head(vivo_atac_subset)
#add fpkm for both gehes
vivo_atac_subset$sertoli_gene_sert_fpkm<-f_soma_mean[vivo_atac_subset$nearest_sertoli_gene_id,]$sertoli
vivo_atac_subset$sertoli_gene_gran_fpkm<-f_soma_mean[vivo_atac_subset$nearest_sertoli_gene_id,]$granulosa
vivo_atac_subset$sertoli_gene_stat<-results_soma[vivo_atac_subset$nearest_sertoli_gene_id,"stat"]
vivo_atac_subset$gran_gene_sert_fpkm<-f_soma_mean[vivo_atac_subset$nearest_granulosa_gene_id,]$sertoli
vivo_atac_subset$gran_gene_gran_fpkm<-f_soma_mean[vivo_atac_subset$nearest_granulosa_gene_id,]$granulosa
vivo_atac_subset$gran_gene_stat<-results_soma[vivo_atac_subset$nearest_granulosa_gene_id,"stat"]

length(s_regions<-vivo_atac_subset[queryHits(s)[mcols(s)$distance < cutoff]])

s_regions$sert_fpkm<-s_regions$sertoli_gene_sert_fpkm
s_regions$gran_fpkm<-s_regions$sertoli_gene_gran_fpkm
s_regions$stat<-s_regions$sertoli_gene_stat

length(g_regions<-vivo_atac_subset[queryHits(g)[mcols(g)$distance < cutoff]])

g_regions$sert_fpkm<-g_regions$gran_gene_sert_fpkm
g_regions$gran_fpkm<-g_regions$gran_gene_gran_fpkm
g_regions$stat<-g_regions$gran_gene_stat

head(g_regions)

#View(as.data.frame(g_regions[g_regions %over% s_regions]))
sum(g_regions %over% s_regions)

g_regions$deg<-"deg_gran"
s_regions$deg<-"deg_sert"
t_regions<-c(g_regions,s_regions)
t_regions<-t_regions[!t_regions %in% g_regions[g_regions %over% s_regions]]

length(t_regions)
#View(as.data.frame((t_regions)))
```

```{r}

temp_1<-t_regions
temp_1$class<-paste0(temp_1$class,":",temp_1$deg) %>% gsub("oli","",.) %>% gsub("deg_","",.) %>% gsub("Constitutive","Con",.) %>% gsub("ulosa","", .)
table(temp_1$class)
temp_2<-peak_center(temp_1) 

df<-data.frame(gran=temp_1$gran_fpkm,sert=temp_1$sert_fpkm,stat=temp_1$stat)

#g_atac_dmrt1<-rtracklayer::import("../data/gran_p7CAGDmrt1_n2_P037_ATACseq_N702.bigWig",selection=temp_2+2000)
#g_atac_control<-rtracklayer::import("../data/gran_p7control_n1_P037_ATACseq_N703.bigWig",selection=temp_2+2000)

g_atac_dmrt1<-rtracklayer::import("../data/N702.R1_trimmed.fastq.bigWig",selection=temp_2+2000) #sertoli
g_atac_control<-rtracklayer::import("../data/N704.R1_trimmed.fastq.bigWig",selection=temp_2+2000) #granulosa
g_p2<-rtracklayer::import("../data/sox9_Index12_DSG_PFA_062315_TACAAG.dedup.unique.bigWig",selection=temp_2+2000)
#g_p3<-rtracklayer::import("../data/ovaryav574_CAGATC.dedup.unique.bigWig",selection=temp_2+2000)

g_p4<-rtracklayer::import("../data/k27ac_noCre.dedup.unique.bigWig",selection=temp_2+2000)
g_p5<-rtracklayer::import("../data/k27ac_dhhCre.dedup.unique.bigWig",selection=temp_2+2000)

seqlevelsStyle(g_atac_dmrt1)<-"UCSC"
seqlevelsStyle(g_atac_control)<-"UCSC"
seqlevelsStyle(g_p2)<-"UCSC"
#seqlevelsStyle(g_p3)<-"UCSC"
seqlevelsStyle(g_p4)<-"UCSC"
seqlevelsStyle(g_p5)<-"UCSC"

mat_dmrt1=normalizeToMatrix(dmrt1_pwm, temp_2, value_column = "score", mean_mode = "absolute",
   extend = 2000, w = 50, smooth = FALSE)
mat_sox9=normalizeToMatrix(sox9_pwm, temp_2, value_column = "score", mean_mode = "absolute",
   extend = 2000, w = 50, smooth = FALSE)
#mat_foxl2=normalizeToMatrix(foxl2_pwm, temp_2, value_column = "score", mean_mode = "absolute",
#   extend = 2000, w = 50, smooth = FALSE)


seqlevelsStyle(temp_2)<-"UCSC"
g_p1<-rtracklayer::import("../data/covaris_6c_sertoli_dmrt1ChIP.R1.fastq.dedup.unique.ucsc.bigWig",selection=temp_2+2000)



mat_p1 = normalizeToMatrix(g_p1, temp_2, value_column = "score",  extend = 2000, mean_mode = "w0", w = 50)
mat_p2 = normalizeToMatrix(g_p2, temp_2, value_column = "score",  extend = 2000, mean_mode = "w0", w = 50)
#mat_p3 = normalizeToMatrix(g_p3, temp_2, value_column = "score",  extend = 2000, mean_mode = "w0", w = 50)
mat_p4 = normalizeToMatrix(g_p4, temp_2, value_column = "score",  extend = 2000, mean_mode = "w0", w = 50)
mat_p5 = normalizeToMatrix(g_p5, temp_2, value_column = "score",  extend = 2000, mean_mode = "w0", w = 50)
mat_ad = normalizeToMatrix(g_atac_dmrt1, temp_2, value_column = "score",  extend = 2000, mean_mode = "w0", w = 50)
mat_ac = normalizeToMatrix(g_atac_control, temp_2, value_column = "score",  extend = 2000, mean_mode = "w0", w = 50)




col_fun_p1= colorRamp2(quantile(mat_p1, c(0, 0.99)), c("white", "darkblue"))
col_fun_p2= colorRamp2(quantile(mat_p2, c(0, 0.99)), c("white", "green"))
#col_fun_p3= colorRamp2(quantile(mat_p3, c(0, 0.99)), c("white", "magenta"))
col_fun_p4= colorRamp2(quantile(mat_p4, c(0, 0.99)), c("white", "black"))
col_fun_p5= colorRamp2(quantile(mat_p5, c(0, 0.99)), c("white", "black"))
col_fun_ac= colorRamp2(quantile(mat_ac, c(0, 0.99)), c("white", "red"))
col_fun_ad= colorRamp2(quantile(mat_ad, c(0, 0.99)), c("white", "blue"))

#mysplit<-ifelse(temp$is.sig,"DeNovo","PreExisting")
#mysplit<-ifelse(g_regions$class,"DeNovo","PreExisting")

col=cbPalette[c(3,5,7,4,6,8)]
#col=c("red","green","blue")

    
  Heatmap(df$gran,name="FPKM Gran",column_title = "Granulosa Expr",show_heatmap_legend = FALSE,column_title_rot=90,split=temp_1$class,width=20,row_order = order(df$stat),cluster_rows = FALSE) + 
  Heatmap(df$sert,name="FPKM Sert",column_title = "Sertoli Expr",show_heatmap_legend = FALSE,column_title_rot=90,split=temp_1$class,width=20)  +
    
  EnrichedHeatmap(mat_ac, col = col_fun_ac, name = "atac_control",column_title = "Granulosa",axis_name_rot = 90,split=temp_1$class,pos_line=F,column_title_rot=90,show_heatmap_legend = FALSE,
                top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = col),ylim=c(0,12),yaxis = F)) ) +
  EnrichedHeatmap(mat_ad, col = col_fun_ad, name = "atac_dmrt1",column_title = "Sertoli",axis_name_rot = 90,split=temp_1$class,pos_line=F,column_title_rot=90,show_heatmap_legend = FALSE,
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = col),ylim=c(0,12),yaxis = F)) ) +
  EnrichedHeatmap(mat_p1, col = col_fun_p1, name = "dmrt1",column_title = "Dmrt1 (Sertoli)",axis_name_rot = 90,pos_line=F,split=temp_1$class,column_title_rot=90,show_heatmap_legend = FALSE,
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = col),ylim=c(0,18),yaxis = F)) ) +
  EnrichedHeatmap(mat_p2, col = col_fun_p2, name = "Sox9",column_title = "Sox9 (Sertoli)",axis_name_rot = 90,pos_line=F,split=temp_1$class,column_title_rot=90,show_heatmap_legend = FALSE,
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = col),ylim=c(0,1.5),yaxis = F)) ) +
  #EnrichedHeatmap(mat_p3, col = col_fun_p3, name = "Foxl2",column_title = "Foxl2 (Ovary)",axis_name_rot = 90,pos_line=F,split=temp_1$class,column_title_rot=90,show_heatmap_legend = FALSE,
  #                top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = col),ylim=c(0,1.5),yaxis = F)) ) +
  EnrichedHeatmap(mat_p4, col = col_fun_p4, name = "k27nc",column_title = "k27 noCRE",axis_name_rot = 90,pos_line=F,split=temp_1$class,column_title_rot=90,show_heatmap_legend = FALSE,
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = col),ylim=c(0,7.5),yaxis = F)) ) +
  EnrichedHeatmap(mat_p5, col = col_fun_p5, name = "k27dhh",column_title = "k27 dHHCRE",axis_name_rot = 90,pos_line=F,split=temp_1$class,column_title_rot=90,show_heatmap_legend = FALSE,
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = col),ylim=c(0,7.5),yaxis = F)) ) +
  EnrichedHeatmap(mat_dmrt1, col = c("white", "darkblue"),pos_line=F, name = "dmrt1_sites", axis_name_rot = 90,column_title = "Dmrt1 Motifs",split=temp_1$class,column_title_rot=90,show_heatmap_legend = FALSE,
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = col),yaxis = T)) ) +
  EnrichedHeatmap(mat_sox9, col = c("white", "darkgreen"),pos_line=F, name = "sox9_sites", axis_name_rot = 90,column_title = "Sox9 Motifs",split=temp_1$class,column_title_rot=90,show_heatmap_legend = FALSE,
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = col),yaxis = T)) ) 
  
    
  #EnrichedHeatmap(mat_foxl2, col = c("white", "magenta"),pos_line=F, name = "foxl2_sites", axis_name_rot = 90,column_title = "Foxl2 Motifs",split=temp_1$class,column_title_rot=90,show_heatmap_legend = FALSE,
  #                top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = col),yaxis = T)) ) 
  
  
  #Heatmap(df$gran,name="FPKM Gran",column_title = "Granulosa Expr",show_heatmap_legend = FALSE,column_title_rot=90,split=temp_1$class,width=20) + 
  #Heatmap(df$sert,name="FPKM Sert",column_title = "Sertoli Expr",show_heatmap_legend = FALSE,column_title_rot=90,split=temp_1$class,width=20)


#  EnrichedHeatmap(mat_p3, col = col_fun_p3, name = "7d Sox9 - Sox9",column_title = "7d Sox9 - Sox9",axis_name_rot = 90,pos_line=F,split=mysplit,column_title_rot=90,show_heatmap_legend = FALSE) +
#  EnrichedHeatmap(mat_p2, col = col_fun_p2, name = "7d Dmrt1 - Sox9",column_title = "7d Dmrt1 - Sox9",pos_line=F,axis_name_rot = 90,split=mysplit,column_title_rot=90,show_heatmap_legend = FALSE) +
#  EnrichedHeatmap(mat_dmrt1, col = c("white", "black"),pos_line=F, name = "dmrt1_sites", axis_name_rot = 90,column_title = "dmrt1_sites",split=mysplit,column_title_rot=90,show_heatmap_legend = FALSE) +
#  EnrichedHeatmap(mat_sox9, col = c("white", "black"),pos_line=F, name = "sox9_sites", axis_name_rot = 90,column_title = "sox9_sites",split=mysplit,column_title_rot=90,show_heatmap_legend = FALSE)
  
```

## Heatmap for Chromatin Only
```{r}
seqlevelsStyle(temp_2)<-"NCBI"
g_p1<-rtracklayer::import("../data/input_noCre.dedup.unique.bigWig",selection=temp_2+2000)
g_p2<-rtracklayer::import("../data/input_dhhCre.dedup.unique.bigWig",selection=temp_2+2000)

g_p3<-rtracklayer::import("../data/k4me1_noCre.dedup.unique.bigWig",selection=temp_2+2000)
g_p4<-rtracklayer::import("../data/k4me1_dhhCre.dedup.unique.bigWig",selection=temp_2+2000)

g_p5<-rtracklayer::import("../data/k27ac_noCre.dedup.unique.bigWig",selection=temp_2+2000)
g_p6<-rtracklayer::import("../data/k27ac_dhhCre.dedup.unique.bigWig",selection=temp_2+2000)

g_p7<-rtracklayer::import("../data/k4me3_noCre.dedup.unique.bigWig",selection=temp_2+2000)
g_p8<-rtracklayer::import("../data/k4me3_dhhCre.dedup.unique.bigWig",selection=temp_2+2000)

g_p9<-rtracklayer::import("../data/k27me3_noCre.dedup.unique.bigWig",selection=temp_2+2000)
g_p10<-rtracklayer::import("../data/k27me3_dhhCre.dedup.unique.bigWig",selection=temp_2+2000)

mat_p1 = normalizeToMatrix(g_p1, temp_2, value_column = "score",  extend = 2000, mean_mode = "w0", w = 50)
mat_p2 = normalizeToMatrix(g_p2, temp_2, value_column = "score",  extend = 2000, mean_mode = "w0", w = 50)
mat_p3 = normalizeToMatrix(g_p3, temp_2, value_column = "score",  extend = 2000, mean_mode = "w0", w = 50)
mat_p4 = normalizeToMatrix(g_p4, temp_2, value_column = "score",  extend = 2000, mean_mode = "w0", w = 50)
mat_p5 = normalizeToMatrix(g_p5, temp_2, value_column = "score",  extend = 2000, mean_mode = "w0", w = 50)
mat_p6 = normalizeToMatrix(g_p6, temp_2, value_column = "score",  extend = 2000, mean_mode = "w0", w = 50)
mat_p7 = normalizeToMatrix(g_p7, temp_2, value_column = "score",  extend = 2000, mean_mode = "w0", w = 50)
mat_p8 = normalizeToMatrix(g_p8, temp_2, value_column = "score",  extend = 2000, mean_mode = "w0", w = 50)
mat_p9 = normalizeToMatrix(g_p9, temp_2, value_column = "score",  extend = 2000, mean_mode = "w0", w = 50)
mat_p10 = normalizeToMatrix(g_p10, temp_2, value_column = "score",  extend = 2000, mean_mode = "w0", w = 50)

col_fun_p1= colorRamp2(quantile(mat_p1, c(0, 0.99)), c("white", "black"))
col_fun_p2= colorRamp2(quantile(mat_p2, c(0, 0.99)), c("white", "black"))
col_fun_p3= colorRamp2(quantile(mat_p3, c(0, 0.99)), c("white", "magenta"))
col_fun_p4= colorRamp2(quantile(mat_p4, c(0, 0.99)), c("white", "magenta"))
col_fun_p5= colorRamp2(quantile(mat_p5, c(0, 0.99)), c("white", "blue"))
col_fun_p6= colorRamp2(quantile(mat_p6, c(0, 0.99)), c("white", "blue"))
col_fun_p7= colorRamp2(quantile(mat_p7, c(0, 0.99)), c("white", "green"))
col_fun_p8= colorRamp2(quantile(mat_p8, c(0, 0.99)), c("white", "green"))
col_fun_p9= colorRamp2(quantile(mat_p9, c(0, 0.99)), c("white", "red"))
col_fun_p10= colorRamp2(quantile(mat_p10, c(0, 0.99)), c("white", "red"))

col=cbPalette[c(3,5,7,4,6,8)]
#ggplot(data.frame(x=rep(10,length(col)),y=letters[1:length(col)]),aes(x=x,fill=y)) + geom_bar() + scale_fill_manual(values=col) + theme_bw()

EnrichedHeatmap(mat_p1, col = col_fun_p1, name = "input_noCre",column_title = "input noCRE",axis_name_rot = 90,pos_line=F,split=temp_1$class,column_title_rot=90,show_heatmap_legend = FALSE,
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = col),ylim=c(0,3),yaxis = F)) ) +
EnrichedHeatmap(mat_p2, col = col_fun_p2, name = "input_dhhCre",column_title = "input dhhCRE",axis_name_rot = 90,pos_line=F,split=temp_1$class,column_title_rot=90,show_heatmap_legend = FALSE,
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = col),ylim=c(0,3),yaxis = F)) ) +
EnrichedHeatmap(mat_p3, col = col_fun_p3, name = "k4me1_noCre",column_title = "k4me1 noCRE",axis_name_rot = 90,pos_line=F,split=temp_1$class,column_title_rot=90,show_heatmap_legend = FALSE,
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = col),ylim=c(0,3),yaxis = F)) ) +
EnrichedHeatmap(mat_p4, col = col_fun_p4, name = "k4me1_dhhCre",column_title = "k4me1 dhhCRE",axis_name_rot = 90,pos_line=F,split=temp_1$class,column_title_rot=90,show_heatmap_legend = FALSE,
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = col),ylim=c(0,3),yaxis = F)) ) +
EnrichedHeatmap(mat_p5, col = col_fun_p5, name = "k27ac_noCre",column_title = "k27ac noCRE",axis_name_rot = 90,pos_line=F,split=temp_1$class,column_title_rot=90,show_heatmap_legend = FALSE,
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = col),ylim=c(0,7.5),yaxis = F)) ) +
EnrichedHeatmap(mat_p6, col = col_fun_p6, name = "k27ac_dhhCre",column_title = "k27ac dhhCRE",axis_name_rot = 90,pos_line=F,split=temp_1$class,column_title_rot=90,show_heatmap_legend = FALSE,
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = col),ylim=c(0,7.5),yaxis = F)) ) +
EnrichedHeatmap(mat_p7, col = col_fun_p7, name = "k4me3_noCre",column_title = "k4me3 noCre",axis_name_rot = 90,pos_line=F,split=temp_1$class,column_title_rot=90,show_heatmap_legend = FALSE,
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = col),ylim=c(0,12),yaxis = F)) ) +
EnrichedHeatmap(mat_p8, col = col_fun_p8, name = "k4me3_dhhCre",column_title = "k4me3_dhhCRE",axis_name_rot = 90,pos_line=F,split=temp_1$class,column_title_rot=90,show_heatmap_legend = FALSE,
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = col),ylim=c(0,12),yaxis = F)) ) +
EnrichedHeatmap(mat_p9, col = col_fun_p9, name = "k27me3_noCre",column_title = "k27me3 noCRE",axis_name_rot = 90,pos_line=F,split=temp_1$class,column_title_rot=90,show_heatmap_legend = FALSE,
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = col),ylim=c(0,2),yaxis = F)) ) +
EnrichedHeatmap(mat_p10, col = col_fun_p10, name = "k27me3_dhhCre",column_title = "k27me3_dhhCRE",axis_name_rot = 90,pos_line=F,split=temp_1$class,column_title_rot=90,show_heatmap_legend = FALSE,
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = col),ylim=c(0,2),yaxis = F)) ) 

```


